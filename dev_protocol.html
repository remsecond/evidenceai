<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EvidenceAI Development Protocol</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .command {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            font-family: monospace;
            margin: 10px 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin: 10px 0;
        }
        .key-point {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EvidenceAI Development Protocol</h1>

        <div class="getting-started" style="background: #1e1e1e; color: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h2 style="color: white; border-bottom: 1px solid #444;">Getting Started</h2>
            
            <div style="margin: 20px 0;">
                <h3 style="color: #4caf50; margin: 0;">Step 1: First Time Setup</h3>
                <p>Open this page in Edge - it's your Mission Control center</p>
            </div>

            <div style="margin: 20px 0;">
                <h3 style="color: #4caf50; margin: 0;">Step 2: Start the Server</h3>
                <p>Click the "Start Server" button at the top of Mission Control</p>
                <ul style="color: #ccc;">
                    <li>Wait for the green status indicator</li>
                    <li>Keep the server window open</li>
                </ul>
            </div>

            <div style="margin: 20px 0;">
                <h3 style="color: #4caf50; margin: 0;">Step 3: Open Workspace</h3>
                <p>Click "Open Workspace" if you see "No workspace detected"</p>
                <ul style="color: #ccc;">
                    <li>This ensures Cline has full project context</li>
                    <li>The workspace indicator will turn green</li>
                </ul>
            </div>

            <div style="margin: 20px 0;">
                <h3 style="color: #4caf50; margin: 0;">Step 4: Start Development</h3>
                <p>Now you can click the blue "Start New Task" button in VS Code</p>
                <ul style="color: #ccc;">
                    <li>Cline will load your previous context</li>
                    <li>Mission Control will track your progress</li>
                    <li>Everything stays in sync automatically</li>
                </ul>
            </div>

            <div class="warning" style="background: #dc3545; margin-top: 20px;">
                <strong>Important:</strong> Always start from Mission Control. This ensures Cline maintains context between sessions.
            </div>
        </div>

        <h2>Development Control Center</h2>
        <style>
            .control-panel {
                background: #1e1e1e;
                border-radius: 8px;
                padding: 20px;
                margin: 20px 0;
                color: white;
            }
            .control-panel h3 {
                color: #fff;
                margin-top: 0;
            }
            .status-indicator {
                display: inline-block;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                margin-right: 8px;
            }
            .status-indicator.active {
                background: #4caf50;
                box-shadow: 0 0 8px #4caf50;
            }
            .status-indicator.inactive {
                background: #f44336;
                box-shadow: 0 0 8px #f44336;
            }
            .action-button {
                display: inline-block;
                padding: 12px 24px;
                background: #007acc;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px 5px;
                text-decoration: none;
            }
            .action-button:hover {
                background: #005999;
            }
            .status-panel {
                background: #252525;
                padding: 15px;
                border-radius: 4px;
                margin: 10px 0;
            }
        </style>
        
        <div class="control-panel">
            <h3>Session Context</h3>
            <div class="status-panel">
                <div id="last-session-info">
                    <div class="connection-status">
                        <span class="status-indicator" id="context-status"></span>
                        <span id="context-text">Connecting to server...</span>
                        <button id="start-server-btn" class="action-button" style="display: none; margin-left: 10px;" onclick="startServer()">
                            Start Server
                        </button>
                    </div>
                    <div class="server-status" style="margin-top: 5px; font-size: 0.9em;">
                        <span id="server-details"></span>
                    </div>
                    <div class="session-details" style="margin-top: 10px;">
                        <strong>Last Session:</strong> <span id="last-session-date">Loading...</span><br>
                        <strong>Focus Area:</strong> <span id="last-focus-area">Loading...</span><br>
                        <strong>Progress:</strong> <span id="last-progress">Loading...</span>
                    </div>
                </div>
            </div>

            <h3>Development Status</h3>
            <div class="status-panel">
                <div>
                    <span class="status-indicator" id="dev-status"></span>
                    <span id="dev-text">Development Inactive</span>
                </div>
            </div>

            <h3>Development Focus</h3>
            <div class="status-panel">
                <div class="focus-options">
                    <select id="focus-area" class="focus-select" aria-label="Select development focus area" title="Development Focus Area">
                        <option value="">Select Focus Area...</option>
                        <optgroup label="Core Pipeline">
                            <option value="pipeline-perf">Performance Improvements</option>
                            <option value="pipeline-scale">Scaling & Architecture</option>
                            <option value="pipeline-test">Testing & Validation</option>
                        </optgroup>
                        <optgroup label="LLM Integration">
                            <option value="llm-data">Source Data Quality</option>
                            <option value="llm-prompts">Prompt Engineering</option>
                            <option value="llm-workflow">Processing Workflows</option>
                        </optgroup>
                        <optgroup label="Interface Development">
                            <option value="ui-customer">Customer Dashboard</option>
                            <option value="ui-admin">Admin Controls</option>
                            <option value="ui-api">API Documentation</option>
                        </optgroup>
                        <optgroup label="Documentation">
                            <option value="docs-tech">Technical Specs</option>
                            <option value="docs-business">Business Requirements</option>
                            <option value="docs-arch">Architecture Design</option>
                        </optgroup>
                    </select>
                    <button class="action-button" onclick="setFocus()" style="margin-left: 10px;">
                        Set Focus
                    </button>
                </div>
                <div id="focus-details" class="focus-details" style="display: none;">
                    <h4>Focus Area Details</h4>
                    <div id="focus-description"></div>
                    <div id="focus-checklist"></div>
                </div>
            </div>

            <h3>Workspace Status</h3>
            <div class="status-panel">
                <div>
                    <span class="status-indicator" id="workspace-status"></span>
                    <span id="workspace-text">Checking workspace...</span>
                </div>
                <button class="action-button" onclick="openWorkspace()">
                    Open Workspace
                </button>
            </div>
            
            <h3>File Processing</h3>
            <div class="status-panel">
                <div style="margin-bottom: 15px;">
                    <label for="input-file" style="display: block; margin-bottom: 10px;">Select Input File:</label>
                    <input type="file" id="input-file" accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
                    <button class="action-button" onclick="document.getElementById('input-file').click()">
                        Choose PDF File
                    </button>
                    <span id="file-name" style="margin-left: 10px; color: #ccc;"></span>
                </div>
                
                <div id="process-controls" style="display: none;">
                    <button class="action-button" onclick="processFile()">
                        Process File
                    </button>
                    <div class="progress-bar" style="margin-top: 10px;">
                        <div id="process-progress" class="fill"></div>
                    </div>
                </div>

                <div id="results-panel" style="display: none; margin-top: 15px;">
                    <h4 style="color: #fff; margin: 0 0 10px 0;">Results</h4>
                    <pre id="results-output" style="background: #1e1e1e; padding: 10px; border-radius: 4px; max-height: 300px; overflow: auto;"></pre>
                    <button class="action-button" onclick="viewFullResults()" style="margin-top: 10px;">
                        View Full Results
                    </button>
                </div>
            </div>
        </div>

        <style>
            .focus-select {
                padding: 8px;
                border-radius: 4px;
                border: 1px solid #444;
                background: #333;
                color: white;
                width: 300px;
                margin-top: 10px;
            }
            .focus-details {
                margin-top: 15px;
                padding: 15px;
                background: #333;
                border-radius: 4px;
            }
            .focus-checklist {
                margin-top: 10px;
            }
            .focus-checklist label {
                display: block;
                margin: 5px 0;
            }
            #focus-description {
                margin: 10px 0;
                line-height: 1.4;
            }
        </style>

        <script>
            const focusDetails = {
                'pipeline-perf': {
                    title: 'Pipeline Performance',
                    description: 'Optimize processing speed and resource usage',
                    checklist: [
                        'Review current bottlenecks',
                        'Profile memory usage',
                        'Test with varied document sizes'
                    ]
                },
                'llm-data': {
                    title: 'LLM Data Quality',
                    description: 'Improve input data preparation and validation',
                    checklist: [
                        'Analyze current data patterns',
                        'Identify preprocessing needs',
                        'Validate chunking results'
                    ]
                },
                // Add other focus areas...
            };

            async function setFocus() {
                const select = document.getElementById('focus-area');
                const details = document.getElementById('focus-details');
                const description = document.getElementById('focus-description');
                const checklist = document.getElementById('focus-checklist');
                const lastFocusArea = document.getElementById('last-focus-area');
                
                const focus = select.value;
                if (!focus) return;

                const focusInfo = focusDetails[focus] || {
                    title: select.options[select.selectedIndex].text,
                    description: 'Focus on ' + select.options[select.selectedIndex].text,
                    checklist: ['Plan approach', 'Implement changes', 'Verify results']
                };

                try {
                    // Update UI to show setting focus
                    lastFocusArea.innerHTML = '<span style="color: #ffd700;">⟳ Updating focus...</span>';
                    
                    // Save focus to session context
                    const response = await fetch('http://localhost:3456/set-focus', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ focus, details: focusInfo })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        
                        // Update focus details display
                        description.innerHTML = `<strong>${focusInfo.title}</strong><br>${focusInfo.description}`;
                        checklist.innerHTML = focusInfo.checklist.map(item => 
                            `<label><input type="checkbox"> ${item}</label>`
                        ).join('');
                        details.style.display = 'block';

                        // Update session info
                        document.getElementById('last-session-date').textContent = new Date(result.session.date).toLocaleString();
                        lastFocusArea.textContent = result.session.focus;
                        document.getElementById('last-progress').textContent = result.session.progress;

                        // Show success feedback
                        const feedback = document.createElement('div');
                        feedback.style.cssText = 'color: #4caf50; margin-top: 10px; font-size: 0.9em;';
                        feedback.innerHTML = '✓ Focus updated successfully';
                        details.appendChild(feedback);
                        setTimeout(() => feedback.remove(), 3000);
                    }
                } catch (error) {
                    console.error('Failed to set focus:', error);
                    lastFocusArea.innerHTML = '<span style="color: #f44336;">Failed to update focus. Try again.</span>';
                }
            }

            // Load and display Cline's context
            async function loadSessionContext() {
                const contextStatus = document.getElementById('context-status');
                const contextText = document.getElementById('context-text');
                const startServerBtn = document.getElementById('start-server-btn');
                const serverDetails = document.getElementById('server-details');
                const lastSessionDate = document.getElementById('last-session-date');
                const lastFocusArea = document.getElementById('last-focus-area');
                const lastProgress = document.getElementById('last-progress');
                
                try {
                    // First check if server is running
                    const healthCheck = await fetch('http://localhost:3456/health')
                        .then(r => r.json())
                        .catch(() => null);

                    if (!healthCheck || healthCheck.status !== 'running') {
                        throw new Error('Server not running');
                    }

                    // If server is running, get session context
                    const response = await fetch('http://localhost:3456/session-context');
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.details || data.error || 'Failed to load context');
                    }
                    
                    // Update session info with context details
                    lastSessionDate.innerHTML = `<span style="color: #4caf50;">✓</span> ${new Date(data.date).toLocaleString()}`;
                    
                    // Show focus area with status
                    if (data.focus && data.focus !== 'Not set') {
                        lastFocusArea.innerHTML = `<span style="color: #4caf50;">✓</span> ${data.focus}`;
                    } else {
                        lastFocusArea.innerHTML = '<span style="color: #ffd700;">⚠️ No focus set</span>';
                    }
                    
                    // Show progress with details
                    if (data.progress) {
                        lastProgress.innerHTML = `<span style="color: #4caf50;">✓</span> ${data.progress}`;
                    } else {
                        lastProgress.innerHTML = '<span style="color: #ffd700;">⚠️ New session started</span>';
                    }
                    
                    // Update server status
                    contextStatus.className = 'status-indicator active';
                    contextText.innerHTML = '<span style="color: #4caf50;">✓</span> Cline initialized with context';
                    startServerBtn.style.display = 'none';
                    serverDetails.innerHTML = `
                        <div style="background: #1e1e1e; padding: 10px; border-radius: 4px; margin-top: 10px;">
                            <span style="color: #4caf50;">✓ Server running with Cline context</span><br>
                            <small style="color: #ccc;">Last session loaded and ready</small>
                        </div>
                    `;
                    return true;
                } catch (error) {
                    console.error('Failed to load session context:', error);
                    serverDetails.innerHTML = `
                        <div style="background: #2d2d2d; padding: 10px; border-radius: 4px; margin: 10px 0;">
                            <span style="color: #f44336;">✗ Error loading context: ${error.message}</span><br>
                            <small style="color: #ccc;">Check server logs for details</small>
                        </div>
                    `;
                }
                
                // Show error state
                contextStatus.className = 'status-indicator inactive';
                contextText.innerHTML = '<span style="color: #f44336;">✗</span> Cline context not loaded';
                startServerBtn.style.display = 'inline-block';
                serverDetails.innerHTML = `
                    <div style="background: #2d2d2d; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <span style="color: #ffd700;">⚠️ Server not running. Run this command:</span><br>
                        <code style="display: block; color: #fff; margin: 10px 0; padding: 5px; background: #1e1e1e; border-radius: 2px; user-select: all;">cd c:/Users/robmo/Desktop/evidenceai && start-test-server.bat</code>
                        <small style="color: #ccc;">This will initialize Cline's context</small>
                    </div>
                `;
                return false;
            }

            // Refresh session context with visual feedback
            async function refreshSessionContext() {
                const success = await loadSessionContext();
                if (success) {
                    // Flash the status indicator to show refresh
                    const contextStatus = document.getElementById('context-status');
                    contextStatus.style.transition = 'none';
                    contextStatus.style.opacity = '0.5';
                    setTimeout(() => {
                        contextStatus.style.transition = 'opacity 0.3s ease';
                        contextStatus.style.opacity = '1';
                    }, 100);
                }
                setTimeout(refreshSessionContext, 5000);
            }

            // Check if VS Code workspace is open
            async function checkWorkspace() {
                const workspaceStatus = document.getElementById('workspace-status');
                const workspaceText = document.getElementById('workspace-text');
                
                try {
                    const response = await fetch('http://localhost:3456/workspace-status');
                    if (response.ok) {
                        workspaceStatus.className = 'status-indicator active';
                        workspaceText.textContent = 'Workspace Active: evidenceai';
                        return true;
                    }
                } catch {}
                
                workspaceStatus.className = 'status-indicator inactive';
                workspaceText.textContent = 'No workspace detected';
                return false;
            }

            // Open the workspace in VS Code
            async function openWorkspace() {
                const workspacePath = 'C:/Users/robmo/Desktop/evidenceai/evidenceai.code-workspace';
                try {
                    // Use VS Code protocol handler to open workspace
                    window.location.href = `vscode://file/${workspacePath}`;
                    
                    // Wait a bit then check workspace status
                    setTimeout(checkWorkspace, 2000);
                } catch (error) {
                    alert('Failed to open workspace. Please open manually in VS Code.');
                }
            }

            // Start development session
            async function startDevelopment() {
                if (!await checkWorkspace()) {
                    if (!confirm('Workspace not detected. Open it now?')) {
                        return;
                    }
                    await openWorkspace();
                }

                try {
                    // Launch dev.bat through the test server
                    const response = await fetch('http://localhost:3456/start-dev', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        document.getElementById('dev-status').className = 'status-indicator active';
                        document.getElementById('dev-text').textContent = 'Development Active';
                    }
                } catch (error) {
                    alert('Failed to start development. Please run dev.bat manually.');
                }
            }

            // Stop development session
            async function stopDevelopment() {
                try {
                    const response = await fetch('http://localhost:3456/stop-dev', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        document.getElementById('dev-status').className = 'status-indicator inactive';
                        document.getElementById('dev-text').textContent = 'Development Stopped';
                    }
                } catch (error) {
                    alert('Failed to stop development. Please run dev.bat stop manually.');
                }
            }

            // Initialize UI elements and start monitoring
            async function initializeUI() {
                // Get all required DOM elements
                const elements = {
                    contextStatus: document.getElementById('context-status'),
                    contextText: document.getElementById('context-text'),
                    startServerBtn: document.getElementById('start-server-btn'),
                    serverDetails: document.getElementById('server-details'),
                    lastSessionDate: document.getElementById('last-session-date'),
                    lastFocusArea: document.getElementById('last-focus-area'),
                    lastProgress: document.getElementById('last-progress'),
                    devStatus: document.getElementById('dev-status'),
                    devText: document.getElementById('dev-text')
                };

                // Verify all elements exist
                for (const [key, element] of Object.entries(elements)) {
                    if (!element) {
                        console.error(`Missing UI element: ${key}`);
                        return false;
                    }
                }

                // Initialize with default states
                elements.contextStatus.className = 'status-indicator inactive';
                elements.contextText.textContent = 'Server not running';
                elements.startServerBtn.style.display = 'inline-block';
                elements.lastSessionDate.textContent = 'Waiting for server...';
                elements.lastFocusArea.textContent = 'Waiting for server...';
                elements.lastProgress.textContent = 'Waiting for server...';
                elements.serverDetails.innerHTML = `
                    <div style="background: #2d2d2d; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <span style="color: #ffd700;">⚠️ Server not running. Run this command:</span><br>
                        <code style="display: block; color: #fff; margin: 10px 0; padding: 5px; background: #1e1e1e; border-radius: 2px; user-select: all;">cd c:/Users/robmo/Desktop/evidenceai && start-test-server.bat</code>
                        <small style="color: #ccc;">This will initialize Cline's context</small>
                    </div>
                `;

                // Start monitoring
                await checkWorkspace();
                await loadSessionContext();
                
                // Start periodic refresh
                setInterval(async () => {
                    const success = await loadSessionContext();
                    if (success) {
                        elements.contextStatus.style.transition = 'none';
                        elements.contextStatus.style.opacity = '0.5';
                        setTimeout(() => {
                            elements.contextStatus.style.transition = 'opacity 0.3s ease';
                            elements.contextStatus.style.opacity = '1';
                        }, 100);
                    }
                }, 5000);

                return true;
            }

            // Check status on page load
            window.addEventListener('DOMContentLoaded', () => {
                console.log('Initializing Mission Control...');
                initializeUI().then(success => {
                    if (success) {
                        console.log('Mission Control initialized');
                    } else {
                        console.error('Failed to initialize Mission Control');
                    }
                });
            });
        </script>

        <h2>Working with CLine</h2>
        <div class="info" style="background: #cce5ff; border: 1px solid #b8daff; color: #004085; padding: 10px; border-radius: 4px; margin: 10px 0;">
            <strong>How CLine Works:</strong>
            <ul>
                <li>CLine needs the workspace context to understand the project</li>
                <li>Always start by explaining what feature you want to build</li>
                <li>CLine will check the last demo to verify previous progress</li>
                <li>Follow CLine's guidance on making small, testable changes</li>
            </ul>
        </div>

        <h2>Development Controls</h2>
        <style>
            .button {
                display: inline-block;
                padding: 12px 24px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px 5px;
                text-decoration: none;
            }
            .button:hover {
                background: #0056b3;
            }
            .button.stop {
                background: #dc3545;
            }
            .button.stop:hover {
                background: #c82333;
            }
        </style>
        <div style="text-align: center; margin: 20px 0;">
            <a href="dev.bat" class="button">Start Development</a>
            <a href="dev.bat stop" class="button stop">Stop Development</a>
        </div>
        <div class="success">
            The system will:
            <ul>
                <li>Show the development protocol</li>
                <li>Ask for your feature goal</li>
                <li>Verify test files</li>
                <li>Start the development server</li>
            </ul>
        </div>

        <div class="success">
            The system will:
            <ul>
                <li>Ask for your demo recording</li>
                <li>Document completed features</li>
                <li>Save the demo for verification</li>
                <li>Update the session log</li>
            </ul>
        </div>

        <h2>Recording Demos</h2>
        <ul>
            <li>Use Windows Game Bar (Win + G)</li>
            <li>OR use any screen recording software</li>
            <li class="key-point">Must record demo before ending session</li>
            <li>Save recording before running dev stop</li>
        </ul>

        <h2>Core Rules</h2>
        <ul>
            <li class="key-point">Every change must be demonstrable</li>
            <li class="key-point">No complexity without working basics</li>
            <li class="key-point">Every session must end with working feature</li>
            <li class="key-point">Next session verifies previous demo</li>
        </ul>

        <div class="warning">
            <strong>Remember:</strong> If you can't demo it, it doesn't exist. Always prioritize working features over perfect code.
        </div>

        <h2>Directory Structure</h2>
        <ul>
            <li><code>demos/</code> - Feature demonstrations</li>
            <li><code>session_logs/</code> - Progress tracking</li>
        </ul>

        <h2>First Time Setup</h2>
        <div class="success">
            The system will automatically:
            <ul>
                <li>Create necessary folders</li>
                <li>Initialize session logging</li>
                <li>Set up demo storage</li>
            </ul>
        </div>
        <div class="warning">
            It's okay if there's no previous demo for the first session only.
        </div>

        <h2>Understanding Context</h2>
        <div class="info" style="background: #cce5ff; border: 1px solid #b8daff; color: #004085; padding: 10px; border-radius: 4px; margin: 10px 0;">
            CLine maintains context through:
            <ul>
                <li>Session logs in <code>session_logs/</code></li>
                <li>Demo recordings in <code>demos/</code></li>
                <li>The workspace configuration</li>
                <li>Git history and changes</li>
            </ul>
            <strong>Important:</strong> Always work in the VS Code workspace and let CLine know what feature you're working on.
        </div>

        <h2>Test Control Center</h2>
        <style>
            .test-panel {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 20px;
                margin: 20px 0;
            }
            .test-button {
                display: inline-block;
                padding: 12px 24px;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px 5px;
                text-decoration: none;
            }
            .test-button:hover {
                background: #218838;
            }
            .test-output {
                background: #000;
                color: #fff;
                padding: 15px;
                border-radius: 4px;
                font-family: monospace;
                margin-top: 10px;
                max-height: 200px;
                overflow-y: auto;
                display: none;
            }
            .progress-bar {
                height: 20px;
                background: #e9ecef;
                border-radius: 4px;
                margin: 10px 0;
                overflow: hidden;
            }
            .progress-bar .fill {
                height: 100%;
                background: #007bff;
                width: 0%;
                transition: width 0.3s ease;
            }
            .test-status {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                margin-left: 10px;
                font-size: 0.9em;
            }
            .test-status.running {
                background: #cce5ff;
                color: #004085;
            }
            .test-status.success {
                background: #d4edda;
                color: #155724;
            }
            .test-status.error {
                background: #f8d7da;
                color: #721c24;
            }
        </style>
        <script>
            // Start test server if not running
            async function checkServer() {
                try {
                    const response = await fetch('http://localhost:3456/health');
                    return response.ok;
                } catch {
                    return false;
                }
            }

            async function startServer(buttonId = 'start-server') {
                const startButton = document.getElementById(buttonId);
                const serverDetails = document.getElementById('server-details');
                
                if (startButton) {
                    startButton.disabled = true;
                    startButton.textContent = 'Starting server...';
                }

                try {
                    // Show command to run
                    serverDetails.innerHTML = `
                        <div style="background: #2d2d2d; padding: 10px; border-radius: 4px; margin: 10px 0;">
                            <span style="color: #ffd700;">⚠️ Run this command to start the server:</span><br>
                            <code style="display: block; color: #fff; margin: 10px 0; padding: 5px; background: #1e1e1e; border-radius: 2px; user-select: all;">cd c:/Users/robmo/Desktop/evidenceai && start-test-server.bat</code>
                            <small style="color: #ccc;">Keep the server window open after running</small>
                        </div>
                    `;

                    // Start polling for server
                    let attempts = 0;
                    const maxAttempts = 30; // 30 seconds timeout
                    const poll = async () => {
                        try {
                            const healthCheck = await fetch('http://localhost:3456/health')
                                .then(r => r.json())
                                .catch(() => null);

                            if (healthCheck?.status === 'running') {
                                updateServerStatus(true, 'Server running');
                                await loadSessionContext();
                                return true;
                            }
                        } catch {}

                        attempts++;
                        if (attempts >= maxAttempts) {
                            throw new Error('Server startup timeout');
                        }

                        // Update progress
                        serverDetails.innerHTML = `
                            <div style="background: #2d2d2d; padding: 10px; border-radius: 4px; margin: 10px 0;">
                                <span style="color: #ffd700;">⟳ Waiting for server... (${attempts}s)</span><br>
                                <small style="color: #ccc;">Make sure you've run the command above</small>
                            </div>
                        `;

                        // Try again in 1 second
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return poll();
                    };

                    return await poll();
                } catch (error) {
                    updateServerStatus(false, 'Server failed to start');
                    serverDetails.innerHTML = `
                        <div style="background: #2d2d2d; padding: 10px; border-radius: 4px; margin: 10px 0;">
                            <span style="color: #f44336;">✗ Server failed to start</span><br>
                            <small style="color: #ccc;">Check the terminal for errors</small>
                        </div>
                    `;
                    return false;
                } finally {
                    if (startButton) {
                        startButton.disabled = false;
                        startButton.textContent = 'Start Server';
                    }
                }
            }

            function updateServerStatus(running, message) {
                // Update all server buttons
                const buttons = ['start-server', 'start-server-btn'];
                buttons.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        if (running) {
                            btn.textContent = 'Server Running';
                            btn.className = btn.className.includes('test-button') ? 
                                'test-button success' : 'action-button';
                            btn.style.display = 'none';
                        } else {
                            btn.textContent = 'Start Server';
                            btn.disabled = false;
                            btn.style.display = 'inline-block';
                        }
                    }
                });

                // Update status indicators
                const serverDetails = document.getElementById('server-details');
                if (serverDetails) {
                    const color = running ? '#4caf50' : '#f44336';
                    const icon = running ? '✓' : '✗';
                    serverDetails.innerHTML = `<span style="color: ${color};">${icon} ${message}</span>`;
                }

                // Update context status
                const contextStatus = document.getElementById('context-status');
                const contextText = document.getElementById('context-text');
                if (contextStatus && contextText) {
                    contextStatus.className = `status-indicator ${running ? 'active' : 'inactive'}`;
                    contextText.textContent = running ? 'Connected to server' : 'Server connection lost';
                }
            }

            async function checkServerStatus() {
                try {
                    const response = await fetch('http://localhost:3456/health');
                    if (response.ok) {
                        const data = await response.json();
                        return { ok: true, ...data };
                    }
                } catch {}
                return { ok: false };
            }

            function showServerError() {
                const message = 
                    'Server failed to start.\n\n' +
                    'Troubleshooting steps:\n' +
                    '1. Check if a server window opened\n' +
                    '2. Look for error messages in the terminal\n' +
                    '3. Click "Start Server" to try again\n' +
                    '4. If problems persist, check system resources\n\n' +
                    'The server must be running to use Mission Control.';
                alert(message);
            }

            // File handling functions
            async function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                document.getElementById('file-name').textContent = file.name;
                document.getElementById('process-controls').style.display = 'block';
                document.getElementById('results-panel').style.display = 'none';
            }

            async function processFile() {
                const fileInput = document.getElementById('input-file');
                const file = fileInput.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    // Show processing status
                    const progressBar = document.getElementById('process-progress');
                    progressBar.style.width = '0%';
                    
                    const response = await fetch('http://localhost:3456/process-file', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error('Processing failed');

                    // Stream the processing output
                    const reader = response.body.getReader();
                    const resultsOutput = document.getElementById('results-output');
                    resultsOutput.textContent = '';
                    document.getElementById('results-panel').style.display = 'block';

                    while (true) {
                        const {done, value} = await reader.read();
                        if (done) break;

                        const text = new TextDecoder().decode(value);
                        resultsOutput.textContent += text;
                        resultsOutput.scrollTop = resultsOutput.scrollHeight;
                        
                        // Update progress bar
                        progressBar.style.width = '100%';
                    }
                } catch (error) {
                    alert('Error processing file: ' + error.message);
                }
            }

            async function viewFullResults() {
                try {
                    const response = await fetch('http://localhost:3456/processing-results');
                    if (!response.ok) throw new Error('Failed to fetch results');

                    const results = await response.json();
                    const resultsOutput = document.getElementById('results-output');
                    resultsOutput.textContent = JSON.stringify(results, null, 2);
                } catch (error) {
                    alert('Error viewing results: ' + error.message);
                }
            }

            async function runTest(testType) {
                const outputDiv = document.getElementById(`${testType}-output`);
                const progressBar = document.getElementById(`${testType}-progress`);
                const statusSpan = document.getElementById(`${testType}-status`);
                
                // Check if server is running
                if (!await checkServer()) {
                    if (!await startServer()) {
                        return;
                    }
                }
                
                outputDiv.style.display = 'block';
                outputDiv.innerHTML = 'Starting test...\n';
                progressBar.querySelector('.fill').style.width = '0%';
                statusSpan.className = 'test-status running';
                statusSpan.textContent = 'Running';

                try {
                    const response = await fetch(`http://localhost:3456/run-test?type=${testType}`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) throw new Error('Test failed');
                    
                    const reader = response.body.getReader();
                    let progress = 0;
                    
                    while(true) {
                        const {done, value} = await reader.read();
                        if (done) break;
                        
                        const text = new TextDecoder().decode(value);
                        outputDiv.innerHTML += text + '\n';
                        outputDiv.scrollTop = outputDiv.scrollHeight;
                        
                        progress += 10;
                        progressBar.querySelector('.fill').style.width = `${Math.min(progress, 100)}%`;
                    }
                    
                    statusSpan.className = 'test-status success';
                    statusSpan.textContent = 'Passed';
                } catch (error) {
                    outputDiv.innerHTML += `Error: ${error.message}\n`;
                    statusSpan.className = 'test-status error';
                    statusSpan.textContent = 'Failed';
                }
            }
        </script>
        

        <div class="test-panel">
            <h3>PDF Processing Tests</h3>
            <button class="test-button" onclick="runTest('pdf-extraction')">
                Run Enhanced Chunking Test
            </button>
            <span id="pdf-extraction-status" class="test-status">Not Run</span>
            <div class="progress-bar">
                <div id="pdf-extraction-progress" class="fill"></div>
            </div>
            <pre id="pdf-extraction-output" class="test-output"></pre>
            <div class="info" style="margin-top: 15px;">
                <strong>Features being tested:</strong>
                <ul>
                    <li>Document structure preservation</li>
                    <li>Parallel chunk processing</li>
                    <li>Metadata tracking</li>
                    <li>Processing statistics</li>
                </ul>
            </div>
        </div>

        <h2>Need Help?</h2>
        <div class="command">
            Ask CLine: "What's the current state of the project?"
        </div>
        <div class="success">
            CLine will:
            <ul>
                <li>Check the latest session logs</li>
                <li>Review recent demos</li>
                <li>Analyze the codebase</li>
                <li>Provide a status update</li>
            </ul>
        </div>

        <h2>Learning From Previous Work</h2>
        <div class="info" style="background: #cce5ff; border: 1px solid #b8daff; color: #004085; padding: 10px; border-radius: 4px; margin: 10px 0;">
            To review past work on a concept, ask CLine:
            <div class="command" style="margin-top: 10px;">
                "Can we review our previous work on [concept]?"
            </div>
            <div class="command" style="margin-top: 10px;">
                "What did we learn about [concept] in past sessions?"
            </div>
            <div class="command" style="margin-top: 10px;">
                "Show me the demos related to [concept]"
            </div>
        </div>
        <div class="success">
            CLine will:
            <ul>
                <li>Search session logs for relevant discussions</li>
                <li>Find related demos in the demos/ directory</li>
                <li>Check Git history for relevant changes</li>
                <li>Analyze code patterns and evolution</li>
                <li>Summarize key learnings and decisions</li>
            </ul>
        </div>
        <div class="warning">
            <strong>Pro Tip:</strong> Before starting work on any concept, always ask about previous work to avoid repeating mistakes and leverage past insights.
        </div>
    </div>
</body>
</html>
